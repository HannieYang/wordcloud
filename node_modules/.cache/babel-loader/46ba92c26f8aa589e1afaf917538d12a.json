{"ast":null,"code":"import { __assign, __rest } from \"tslib\";\nimport { get } from '@antv/util';\nimport { interaction, animation, theme, state, scale, annotation } from '../../adaptor/common';\nimport { interval } from '../../adaptor/geometries';\nimport { getLocale } from '../../core/locale';\nimport { findGeometry, flow, transformLabel, deepAssign } from '../../utils';\nimport { Y_FIELD, ABSOLUTE_FIELD, DIFF_FIELD, IS_TOTAL } from './constant';\nimport { transformData } from './utils';\nimport './shape';\n/**\n *  处理默认配置项\n * @param params\n * @returns\n */\n\nfunction defaultOptions(params) {\n  var _a = params.options,\n      locale = _a.locale,\n      total = _a.total;\n  var localeTotalLabel = getLocale(locale).get(['waterfall', 'total']);\n\n  if (total && typeof total.label !== 'string' && localeTotalLabel) {\n    // @ts-ignore\n    params.options.total.label = localeTotalLabel;\n  }\n\n  return params;\n}\n/**\n * 字段\n * @param params\n */\n\n\nfunction geometry(params) {\n  var chart = params.chart,\n      options = params.options;\n  var data = options.data,\n      xField = options.xField,\n      yField = options.yField,\n      total = options.total,\n      leaderLine = options.leaderLine,\n      columnWidthRatio = options.columnWidthRatio,\n      waterfallStyle = options.waterfallStyle,\n      risingFill = options.risingFill,\n      fallingFill = options.fallingFill,\n      color = options.color; // 数据处理\n\n  chart.data(transformData(data, xField, yField, total)); // 瀑布图自带的 colorMapping\n\n  var colorMapping = color || function (datum) {\n    if (get(datum, [IS_TOTAL])) {\n      return get(total, ['style', 'fill'], '');\n    }\n\n    return get(datum, [Y_FIELD, 1]) - get(datum, [Y_FIELD, 0]) > 0 ? risingFill : fallingFill;\n  };\n\n  var p = deepAssign({}, params, {\n    options: {\n      xField: xField,\n      yField: Y_FIELD,\n      seriesField: xField,\n      rawFields: [yField, DIFF_FIELD, IS_TOTAL, Y_FIELD],\n      widthRatio: columnWidthRatio,\n      interval: {\n        style: waterfallStyle,\n        shape: 'waterfall',\n        color: colorMapping\n      }\n    }\n  });\n  var ext = interval(p).ext;\n  var geometry = ext.geometry; // 将 waterfall leaderLineCfg 传入到自定义 shape 中\n\n  geometry.customInfo({\n    leaderLine: leaderLine\n  });\n  return params;\n}\n/**\n * meta 配置\n * @param params\n */\n\n\nfunction meta(params) {\n  var _a, _b;\n\n  var options = params.options;\n  var xAxis = options.xAxis,\n      yAxis = options.yAxis,\n      xField = options.xField,\n      yField = options.yField,\n      meta = options.meta;\n  var Y_FIELD_META = deepAssign({}, {\n    alias: yField\n  }, get(meta, yField));\n  return flow(scale((_a = {}, _a[xField] = xAxis, _a[yField] = yAxis, _a[Y_FIELD] = yAxis, _a), deepAssign({}, meta, (_b = {}, _b[Y_FIELD] = Y_FIELD_META, _b[DIFF_FIELD] = Y_FIELD_META, _b[ABSOLUTE_FIELD] = Y_FIELD_META, _b))))(params);\n}\n/**\n * axis 配置\n * @param params\n */\n\n\nfunction axis(params) {\n  var chart = params.chart,\n      options = params.options;\n  var xAxis = options.xAxis,\n      yAxis = options.yAxis,\n      xField = options.xField,\n      yField = options.yField; // 为 false 则是不显示轴\n\n  if (xAxis === false) {\n    chart.axis(xField, false);\n  } else {\n    chart.axis(xField, xAxis);\n  }\n\n  if (yAxis === false) {\n    chart.axis(yField, false);\n    chart.axis(Y_FIELD, false);\n  } else {\n    chart.axis(yField, yAxis);\n    chart.axis(Y_FIELD, yAxis);\n  }\n\n  return params;\n}\n/**\n * legend 配置 todo 添加 hover 交互\n * @param params\n */\n\n\nfunction legend(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend,\n      total = options.total,\n      risingFill = options.risingFill,\n      fallingFill = options.fallingFill,\n      locale = options.locale;\n  var i18n = getLocale(locale);\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    var items = [{\n      name: i18n.get(['general', 'increase']),\n      value: 'increase',\n      marker: {\n        symbol: 'square',\n        style: {\n          r: 5,\n          fill: risingFill\n        }\n      }\n    }, {\n      name: i18n.get(['general', 'decrease']),\n      value: 'decrease',\n      marker: {\n        symbol: 'square',\n        style: {\n          r: 5,\n          fill: fallingFill\n        }\n      }\n    }];\n\n    if (total) {\n      items.push({\n        name: total.label || '',\n        value: 'total',\n        marker: {\n          symbol: 'square',\n          style: deepAssign({}, {\n            r: 5\n          }, get(total, 'style'))\n        }\n      });\n    }\n\n    chart.legend(deepAssign({}, {\n      custom: true,\n      position: 'top',\n      items: items\n    }, legend));\n    chart.removeInteraction('legend-filter');\n  }\n\n  return params;\n}\n/**\n * 数据标签\n * @param params\n */\n\n\nfunction label(params) {\n  var chart = params.chart,\n      options = params.options;\n  var label = options.label,\n      labelMode = options.labelMode,\n      xField = options.xField;\n  var geometry = findGeometry(chart, 'interval');\n\n  if (!label) {\n    geometry.label(false);\n  } else {\n    var callback = label.callback,\n        cfg = __rest(label, [\"callback\"]);\n\n    geometry.label({\n      fields: labelMode === 'absolute' ? [ABSOLUTE_FIELD, xField] : [DIFF_FIELD, xField],\n      callback: callback,\n      cfg: transformLabel(cfg)\n    });\n  }\n\n  return params;\n}\n/**\n * tooltip 配置\n * @param params\n */\n\n\nexport function tooltip(params) {\n  var chart = params.chart,\n      options = params.options;\n  var tooltip = options.tooltip,\n      xField = options.xField,\n      yField = options.yField;\n\n  if (tooltip !== false) {\n    chart.tooltip(__assign({\n      showCrosshairs: false,\n      showMarkers: false,\n      shared: true,\n      // tooltip 默认展示 y 字段值\n      fields: [yField]\n    }, tooltip)); // 瀑布图默认以 yField 作为 tooltip 内容\n\n    var geometry_1 = chart.geometries[0];\n    (tooltip === null || tooltip === void 0 ? void 0 : tooltip.formatter) ? geometry_1.tooltip(xField + \"*\" + yField, tooltip.formatter) : geometry_1.tooltip(yField);\n  } else {\n    chart.tooltip(false);\n  }\n\n  return params;\n}\n/**\n * 瀑布图适配器\n * @param params\n */\n\nexport function adaptor(params) {\n  return flow(defaultOptions, theme, geometry, meta, axis, legend, tooltip, label, state, interaction, animation, annotation())(params);\n}","map":{"version":3,"mappings":";AACA,SAASA,GAAT,QAAoB,YAApB;AAGA,SAASC,WAAT,EAAsBC,SAAtB,EAAiCC,KAAjC,EAAwCC,KAAxC,EAA+CC,KAA/C,EAAsDC,UAAtD,QAAwE,sBAAxE;AACA,SAASC,QAAT,QAAyB,0BAAzB;AACA,SAASC,SAAT,QAA0B,mBAA1B;AACA,SAASC,YAAT,EAAuBC,IAAvB,EAA6BC,cAA7B,EAA6CC,UAA7C,QAA+D,aAA/D;AACA,SAASC,OAAT,EAAkBC,cAAlB,EAAkCC,UAAlC,EAA8CC,QAA9C,QAA8D,YAA9D;AAEA,SAASC,aAAT,QAA8B,SAA9B;AACA,OAAO,SAAP;AAEA;;;;;;AAKA,SAASC,cAAT,CAAwBC,MAAxB,EAAwD;EAChD,SAAoBA,MAAM,CAACC,OAA3B;EAAA,IAAEC,MAAM,YAAR;EAAA,IAAUC,KAAK,WAAf;EAEN,IAAMC,gBAAgB,GAAGf,SAAS,CAACa,MAAD,CAAT,CAAkBrB,GAAlB,CAAsB,CAAC,WAAD,EAAc,OAAd,CAAtB,CAAzB;;EAEA,IAAIsB,KAAK,IAAI,OAAOA,KAAK,CAACE,KAAb,KAAuB,QAAhC,IAA4CD,gBAAhD,EAAkE;IAChE;IACAJ,MAAM,CAACC,OAAP,CAAeE,KAAf,CAAqBE,KAArB,GAA6BD,gBAA7B;EACD;;EAED,OAAOJ,MAAP;AACD;AAED;;;;;;AAIA,SAASM,QAAT,CAAkBN,MAAlB,EAAkD;EACxC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOC,OAAO,GAAKD,MAAM,QAAzB;EACA,QAAI,GACVC,OAAO,KADD;EAAA,IAAMM,MAAM,GAClBN,OAAO,OADD;EAAA,IAAcO,MAAM,GAC1BP,OAAO,OADD;EAAA,IAAsBE,KAAK,GACjCF,OAAO,MADD;EAAA,IAA6BQ,UAAU,GAC7CR,OAAO,WADD;EAAA,IAAyCS,gBAAgB,GAC/DT,OAAO,iBADD;EAAA,IAA2DU,cAAc,GAC/EV,OAAO,eADD;EAAA,IAA2EW,UAAU,GAC3FX,OAAO,WADD;EAAA,IAAuFY,WAAW,GACxGZ,OAAO,YADD;EAAA,IAAoGa,KAAK,GAC/Gb,OAAO,MADD,CAFwC,CAKhD;;EACAc,KAAK,CAACC,IAAN,CAAWlB,aAAa,CAACkB,IAAD,EAAOT,MAAP,EAAeC,MAAf,EAAuBL,KAAvB,CAAxB,EANgD,CAQhD;;EACA,IAAMc,YAAY,GAChBH,KAAK,IACL,UAAUI,KAAV,EAAsB;IACpB,IAAIrC,GAAG,CAACqC,KAAD,EAAQ,CAACrB,QAAD,CAAR,CAAP,EAA4B;MAC1B,OAAOhB,GAAG,CAACsB,KAAD,EAAQ,CAAC,OAAD,EAAU,MAAV,CAAR,EAA2B,EAA3B,CAAV;IACD;;IACD,OAAOtB,GAAG,CAACqC,KAAD,EAAQ,CAACxB,OAAD,EAAU,CAAV,CAAR,CAAH,GAA2Bb,GAAG,CAACqC,KAAD,EAAQ,CAACxB,OAAD,EAAU,CAAV,CAAR,CAA9B,GAAsD,CAAtD,GAA0DkB,UAA1D,GAAuEC,WAA9E;EACD,CAPH;;EASA,IAAMM,CAAC,GAAG1B,UAAU,CAAC,EAAD,EAAKO,MAAL,EAAa;IAC/BC,OAAO,EAAE;MACPM,MAAM,EAAEA,MADD;MAEPC,MAAM,EAAEd,OAFD;MAGP0B,WAAW,EAAEb,MAHN;MAIPc,SAAS,EAAE,CAACb,MAAD,EAASZ,UAAT,EAAqBC,QAArB,EAA+BH,OAA/B,CAJJ;MAKP4B,UAAU,EAAEZ,gBALL;MAMPtB,QAAQ,EAAE;QACRmC,KAAK,EAAEZ,cADC;QAERa,KAAK,EAAE,WAFC;QAGRV,KAAK,EAAEG;MAHC;IANH;EADsB,CAAb,CAApB;EAcQ,OAAG,GAAK7B,QAAQ,CAAC+B,CAAD,CAAR,CAAWM,GAAnB;EACR,IAAMnB,QAAQ,GAAGmB,GAAG,CAACnB,QAArB,CAjCgD,CAmChD;;EACAA,QAAQ,CAACoB,UAAT,CAAoB;IAAEjB,UAAU;EAAZ,CAApB;EAEA,OAAOT,MAAP;AACD;AAED;;;;;;AAIA,SAAS2B,IAAT,CAAc3B,MAAd,EAA8C;;;EACpC,WAAO,GAAKA,MAAM,QAAlB;EACA,SAAK,GAAkCC,OAAO,MAA9C;EAAA,IAAO2B,KAAK,GAA2B3B,OAAO,MAA9C;EAAA,IAAcM,MAAM,GAAmBN,OAAO,OAA9C;EAAA,IAAsBO,MAAM,GAAWP,OAAO,OAA9C;EAAA,IAA8B0B,IAAI,GAAK1B,OAAO,KAA9C;EAER,IAAM4B,YAAY,GAAGpC,UAAU,CAAC,EAAD,EAAK;IAAEqC,KAAK,EAAEtB;EAAT,CAAL,EAAwB3B,GAAG,CAAC8C,IAAD,EAAOnB,MAAP,CAA3B,CAA/B;EAEA,OAAOjB,IAAI,CACTL,KAAK,WAED6C,GAACxB,MAAD,IAAUyB,KAFT,EAGDD,GAACvB,MAAD,IAAUoB,KAHT,EAIDG,GAACrC,OAAD,IAAWkC,KAJV,OAMHnC,UAAU,CAAC,EAAD,EAAKkC,IAAL,GAASM,SAAIA,GAACvC,OAAD,IAAWmC,YAAf,EAA6BI,GAACrC,UAAD,IAAciC,YAA3C,EAAyDI,GAACtC,cAAD,IAAkBkC,YAA3E,EAAuFI,EAAhG,EANP,CADI,CAAJ,CASLjC,MATK,CAAP;AAUD;AAED;;;;;;AAIA,SAASkC,IAAT,CAAclC,MAAd,EAA8C;EACpC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOC,OAAO,GAAKD,MAAM,QAAzB;EACA,SAAK,GAA4BC,OAAO,MAAxC;EAAA,IAAO2B,KAAK,GAAqB3B,OAAO,MAAxC;EAAA,IAAcM,MAAM,GAAaN,OAAO,OAAxC;EAAA,IAAsBO,MAAM,GAAKP,OAAO,OAAxC,CAFoC,CAI5C;;EACA,IAAI+B,KAAK,KAAK,KAAd,EAAqB;IACnBjB,KAAK,CAACmB,IAAN,CAAW3B,MAAX,EAAmB,KAAnB;EACD,CAFD,MAEO;IACLQ,KAAK,CAACmB,IAAN,CAAW3B,MAAX,EAAmByB,KAAnB;EACD;;EAED,IAAIJ,KAAK,KAAK,KAAd,EAAqB;IACnBb,KAAK,CAACmB,IAAN,CAAW1B,MAAX,EAAmB,KAAnB;IACAO,KAAK,CAACmB,IAAN,CAAWxC,OAAX,EAAoB,KAApB;EACD,CAHD,MAGO;IACLqB,KAAK,CAACmB,IAAN,CAAW1B,MAAX,EAAmBoB,KAAnB;IACAb,KAAK,CAACmB,IAAN,CAAWxC,OAAX,EAAoBkC,KAApB;EACD;;EAED,OAAO5B,MAAP;AACD;AAED;;;;;;AAIA,SAASmC,MAAT,CAAgBnC,MAAhB,EAAgD;EACtC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOC,OAAO,GAAKD,MAAM,QAAzB;EACA,UAAM,GAA6CC,OAAO,OAA1D;EAAA,IAAQE,KAAK,GAAsCF,OAAO,MAA1D;EAAA,IAAeW,UAAU,GAA0BX,OAAO,WAA1D;EAAA,IAA2BY,WAAW,GAAaZ,OAAO,YAA1D;EAAA,IAAwCC,MAAM,GAAKD,OAAO,OAA1D;EAER,IAAMmC,IAAI,GAAG/C,SAAS,CAACa,MAAD,CAAtB;;EAEA,IAAIiC,MAAM,KAAK,KAAf,EAAsB;IACpBpB,KAAK,CAACoB,MAAN,CAAa,KAAb;EACD,CAFD,MAEO;IACL,IAAME,KAAK,GAAG,CACZ;MACEC,IAAI,EAAEF,IAAI,CAACvD,GAAL,CAAS,CAAC,SAAD,EAAY,UAAZ,CAAT,CADR;MAEE0D,KAAK,EAAE,UAFT;MAGEC,MAAM,EAAE;QAAEC,MAAM,EAAE,QAAV;QAAoBlB,KAAK,EAAE;UAAEmB,CAAC,EAAE,CAAL;UAAQC,IAAI,EAAE/B;QAAd;MAA3B;IAHV,CADY,EAMZ;MACE0B,IAAI,EAAEF,IAAI,CAACvD,GAAL,CAAS,CAAC,SAAD,EAAY,UAAZ,CAAT,CADR;MAEE0D,KAAK,EAAE,UAFT;MAGEC,MAAM,EAAE;QAAEC,MAAM,EAAE,QAAV;QAAoBlB,KAAK,EAAE;UAAEmB,CAAC,EAAE,CAAL;UAAQC,IAAI,EAAE9B;QAAd;MAA3B;IAHV,CANY,CAAd;;IAaA,IAAIV,KAAJ,EAAW;MACTkC,KAAK,CAACO,IAAN,CAAW;QACTN,IAAI,EAAEnC,KAAK,CAACE,KAAN,IAAe,EADZ;QAETkC,KAAK,EAAE,OAFE;QAGTC,MAAM,EAAE;UACNC,MAAM,EAAE,QADF;UAENlB,KAAK,EAAE9B,UAAU,CAAC,EAAD,EAAK;YAAEiD,CAAC,EAAE;UAAL,CAAL,EAAe7D,GAAG,CAACsB,KAAD,EAAQ,OAAR,CAAlB;QAFX;MAHC,CAAX;IAQD;;IACDY,KAAK,CAACoB,MAAN,CACE1C,UAAU,CACR,EADQ,EAER;MACEoD,MAAM,EAAE,IADV;MAEEC,QAAQ,EAAE,KAFZ;MAGET,KAAK;IAHP,CAFQ,EAORF,MAPQ,CADZ;IAWApB,KAAK,CAACgC,iBAAN,CAAwB,eAAxB;EACD;;EAED,OAAO/C,MAAP;AACD;AAED;;;;;;AAIA,SAASK,KAAT,CAAeL,MAAf,EAA+C;EACrC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOC,OAAO,GAAKD,MAAM,QAAzB;EACA,SAAK,GAAwBC,OAAO,MAApC;EAAA,IAAO+C,SAAS,GAAa/C,OAAO,UAApC;EAAA,IAAkBM,MAAM,GAAKN,OAAO,OAApC;EAER,IAAMK,QAAQ,GAAGhB,YAAY,CAACyB,KAAD,EAAQ,UAAR,CAA7B;;EAEA,IAAI,CAACV,KAAL,EAAY;IACVC,QAAQ,CAACD,KAAT,CAAe,KAAf;EACD,CAFD,MAEO;IACG,YAAQ,GAAaA,KAAK,SAA1B;IAAA,IAAa4C,GAAG,UAAK5C,KAAL,EAAlB,YAAkB,CAAhB;;IACRC,QAAQ,CAACD,KAAT,CAAe;MACb6C,MAAM,EAAEF,SAAS,KAAK,UAAd,GAA2B,CAACrD,cAAD,EAAiBY,MAAjB,CAA3B,GAAsD,CAACX,UAAD,EAAaW,MAAb,CADjD;MAEb4C,QAAQ,UAFK;MAGbF,GAAG,EAAEzD,cAAc,CAACyD,GAAD;IAHN,CAAf;EAKD;;EAED,OAAOjD,MAAP;AACD;AAED;;;;;;AAIA,OAAM,SAAUoD,OAAV,CAAkBpD,MAAlB,EAAkD;EAC9C,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOC,OAAO,GAAKD,MAAM,QAAzB;EACA,WAAO,GAAqBC,OAAO,QAAnC;EAAA,IAASM,MAAM,GAAaN,OAAO,OAAnC;EAAA,IAAiBO,MAAM,GAAKP,OAAO,OAAnC;;EAER,IAAImD,OAAO,KAAK,KAAhB,EAAuB;IACrBrC,KAAK,CAACqC,OAAN,CAAaC;MACXC,cAAc,EAAE,KADL;MAEXC,WAAW,EAAE,KAFF;MAGXC,MAAM,EAAE,IAHG;MAIX;MACAN,MAAM,EAAE,CAAC1C,MAAD;IALG,GAMR4C,OANQ,CAAb,EADqB,CASrB;;IACA,IAAMK,UAAQ,GAAG1C,KAAK,CAAC2C,UAAN,CAAiB,CAAjB,CAAjB;IACA,QAAO,SAAP,WAAO,WAAP,GAAO,MAAP,UAAO,CAAEC,SAAT,IAAqBF,UAAQ,CAACL,OAAT,CAAoB7C,MAAM,MAAN,GAAUC,MAA9B,EAAwC4C,OAAO,CAACO,SAAhD,CAArB,GAAkFF,UAAQ,CAACL,OAAT,CAAiB5C,MAAjB,CAAlF;EACD,CAZD,MAYO;IACLO,KAAK,CAACqC,OAAN,CAAc,KAAd;EACD;;EAED,OAAOpD,MAAP;AACD;AAED;;;;;AAIA,OAAM,SAAU4D,OAAV,CAAkB5D,MAAlB,EAAkD;EACtD,OAAOT,IAAI,CACTQ,cADS,EAETf,KAFS,EAGTsB,QAHS,EAITqB,IAJS,EAKTO,IALS,EAMTC,MANS,EAOTiB,OAPS,EAQT/C,KARS,EASTpB,KATS,EAUTH,WAVS,EAWTC,SAXS,EAYTI,UAAU,EAZD,CAAJ,CAaLa,MAbK,CAAP;AAcD","names":["get","interaction","animation","theme","state","scale","annotation","interval","getLocale","findGeometry","flow","transformLabel","deepAssign","Y_FIELD","ABSOLUTE_FIELD","DIFF_FIELD","IS_TOTAL","transformData","defaultOptions","params","options","locale","total","localeTotalLabel","label","geometry","xField","yField","leaderLine","columnWidthRatio","waterfallStyle","risingFill","fallingFill","color","chart","data","colorMapping","datum","p","seriesField","rawFields","widthRatio","style","shape","ext","customInfo","meta","yAxis","Y_FIELD_META","alias","_a","xAxis","_b","axis","legend","i18n","items","name","value","marker","symbol","r","fill","push","custom","position","removeInteraction","labelMode","cfg","fields","callback","tooltip","__assign","showCrosshairs","showMarkers","shared","geometry_1","geometries","formatter","adaptor"],"sourceRoot":"","sources":["../../../src/plots/waterfall/adaptor.ts"],"sourcesContent":["import { Geometry } from '@antv/g2';\nimport { get } from '@antv/util';\nimport { Datum } from '../../types';\nimport { Params } from '../../core/adaptor';\nimport { interaction, animation, theme, state, scale, annotation } from '../../adaptor/common';\nimport { interval } from '../../adaptor/geometries';\nimport { getLocale } from '../../core/locale';\nimport { findGeometry, flow, transformLabel, deepAssign } from '../../utils';\nimport { Y_FIELD, ABSOLUTE_FIELD, DIFF_FIELD, IS_TOTAL } from './constant';\nimport { WaterfallOptions } from './types';\nimport { transformData } from './utils';\nimport './shape';\n\n/**\n *  处理默认配置项\n * @param params\n * @returns\n */\nfunction defaultOptions(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { locale, total } = params.options;\n\n  const localeTotalLabel = getLocale(locale).get(['waterfall', 'total']);\n\n  if (total && typeof total.label !== 'string' && localeTotalLabel) {\n    // @ts-ignore\n    params.options.total.label = localeTotalLabel;\n  }\n\n  return params;\n}\n\n/**\n * 字段\n * @param params\n */\nfunction geometry(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { chart, options } = params;\n  const { data, xField, yField, total, leaderLine, columnWidthRatio, waterfallStyle, risingFill, fallingFill, color } =\n    options;\n\n  // 数据处理\n  chart.data(transformData(data, xField, yField, total));\n\n  // 瀑布图自带的 colorMapping\n  const colorMapping =\n    color ||\n    function (datum: Datum) {\n      if (get(datum, [IS_TOTAL])) {\n        return get(total, ['style', 'fill'], '');\n      }\n      return get(datum, [Y_FIELD, 1]) - get(datum, [Y_FIELD, 0]) > 0 ? risingFill : fallingFill;\n    };\n\n  const p = deepAssign({}, params, {\n    options: {\n      xField: xField,\n      yField: Y_FIELD,\n      seriesField: xField,\n      rawFields: [yField, DIFF_FIELD, IS_TOTAL, Y_FIELD],\n      widthRatio: columnWidthRatio,\n      interval: {\n        style: waterfallStyle,\n        shape: 'waterfall',\n        color: colorMapping,\n      },\n    },\n  });\n  const { ext } = interval(p);\n  const geometry = ext.geometry as Geometry;\n\n  // 将 waterfall leaderLineCfg 传入到自定义 shape 中\n  geometry.customInfo({ leaderLine });\n\n  return params;\n}\n\n/**\n * meta 配置\n * @param params\n */\nfunction meta(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { options } = params;\n  const { xAxis, yAxis, xField, yField, meta } = options;\n\n  const Y_FIELD_META = deepAssign({}, { alias: yField }, get(meta, yField));\n\n  return flow(\n    scale(\n      {\n        [xField]: xAxis,\n        [yField]: yAxis,\n        [Y_FIELD]: yAxis,\n      },\n      deepAssign({}, meta, { [Y_FIELD]: Y_FIELD_META, [DIFF_FIELD]: Y_FIELD_META, [ABSOLUTE_FIELD]: Y_FIELD_META })\n    )\n  )(params);\n}\n\n/**\n * axis 配置\n * @param params\n */\nfunction axis(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { chart, options } = params;\n  const { xAxis, yAxis, xField, yField } = options;\n\n  // 为 false 则是不显示轴\n  if (xAxis === false) {\n    chart.axis(xField, false);\n  } else {\n    chart.axis(xField, xAxis);\n  }\n\n  if (yAxis === false) {\n    chart.axis(yField, false);\n    chart.axis(Y_FIELD, false);\n  } else {\n    chart.axis(yField, yAxis);\n    chart.axis(Y_FIELD, yAxis);\n  }\n\n  return params;\n}\n\n/**\n * legend 配置 todo 添加 hover 交互\n * @param params\n */\nfunction legend(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { chart, options } = params;\n  const { legend, total, risingFill, fallingFill, locale } = options;\n\n  const i18n = getLocale(locale);\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    const items = [\n      {\n        name: i18n.get(['general', 'increase']),\n        value: 'increase',\n        marker: { symbol: 'square', style: { r: 5, fill: risingFill } },\n      },\n      {\n        name: i18n.get(['general', 'decrease']),\n        value: 'decrease',\n        marker: { symbol: 'square', style: { r: 5, fill: fallingFill } },\n      },\n    ];\n\n    if (total) {\n      items.push({\n        name: total.label || '',\n        value: 'total',\n        marker: {\n          symbol: 'square',\n          style: deepAssign({}, { r: 5 }, get(total, 'style')),\n        },\n      });\n    }\n    chart.legend(\n      deepAssign(\n        {},\n        {\n          custom: true,\n          position: 'top',\n          items,\n        },\n        legend\n      )\n    );\n    chart.removeInteraction('legend-filter');\n  }\n\n  return params;\n}\n\n/**\n * 数据标签\n * @param params\n */\nfunction label(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { chart, options } = params;\n  const { label, labelMode, xField } = options;\n\n  const geometry = findGeometry(chart, 'interval');\n\n  if (!label) {\n    geometry.label(false);\n  } else {\n    const { callback, ...cfg } = label;\n    geometry.label({\n      fields: labelMode === 'absolute' ? [ABSOLUTE_FIELD, xField] : [DIFF_FIELD, xField],\n      callback,\n      cfg: transformLabel(cfg),\n    });\n  }\n\n  return params;\n}\n\n/**\n * tooltip 配置\n * @param params\n */\nexport function tooltip(params: Params<WaterfallOptions>): Params<WaterfallOptions> {\n  const { chart, options } = params;\n  const { tooltip, xField, yField } = options;\n\n  if (tooltip !== false) {\n    chart.tooltip({\n      showCrosshairs: false,\n      showMarkers: false,\n      shared: true,\n      // tooltip 默认展示 y 字段值\n      fields: [yField],\n      ...tooltip,\n    });\n    // 瀑布图默认以 yField 作为 tooltip 内容\n    const geometry = chart.geometries[0];\n    tooltip?.formatter ? geometry.tooltip(`${xField}*${yField}`, tooltip.formatter) : geometry.tooltip(yField);\n  } else {\n    chart.tooltip(false);\n  }\n\n  return params;\n}\n\n/**\n * 瀑布图适配器\n * @param params\n */\nexport function adaptor(params: Params<WaterfallOptions>) {\n  return flow(\n    defaultOptions,\n    theme,\n    geometry,\n    meta,\n    axis,\n    legend,\n    tooltip,\n    label,\n    state,\n    interaction,\n    animation,\n    annotation()\n  )(params);\n}\n"]},"metadata":{},"sourceType":"module"}