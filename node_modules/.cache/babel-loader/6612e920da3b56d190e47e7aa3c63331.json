{"ast":null,"code":"import { isFunction, clone } from '@antv/util';\nimport { interaction, animation, theme, scale, annotation, tooltip } from '../../adaptor/common';\nimport { getLocale } from '../../core/locale';\nimport { flow, deepAssign } from '../../utils';\nimport { conversionTagFormatter } from '../../utils/conversion';\nimport { basicFunnel } from './geometries/basic';\nimport { compareFunnel } from './geometries/compare';\nimport { facetFunnel } from './geometries/facet';\nimport { dynamicHeightFunnel } from './geometries/dynamic-height';\nimport { FUNNEL_CONVERSATION, FUNNEL_PERCENT } from './constant';\n/**\n *\n * 各式漏斗图geometry实现细节有较大不同,\n * 1. 普通漏斗图：interval.shape('funnel')\n * 2. 对比漏斗图：分面\n * 3. 动态高度漏斗图：polypon\n * 4. 分面漏斗图：普通 + list 分面\n* /\n\n/**\n * options 处理\n * @param params\n */\n\nfunction defaultOptions(params) {\n  var options = params.options;\n  var compareField = options.compareField,\n      xField = options.xField,\n      yField = options.yField,\n      locale = options.locale,\n      funnelStyle = options.funnelStyle,\n      data = options.data;\n  var i18n = getLocale(locale);\n  var defaultOption = {\n    label: compareField ? {\n      fields: [xField, yField, compareField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n      formatter: function (datum) {\n        return \"\" + datum[yField];\n      }\n    } : {\n      fields: [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n      offset: 0,\n      position: 'middle',\n      formatter: function (datum) {\n        return datum[xField] + \" \" + datum[yField];\n      }\n    },\n    tooltip: {\n      title: xField,\n      formatter: function (datum) {\n        return {\n          name: datum[xField],\n          value: datum[yField]\n        };\n      }\n    },\n    conversionTag: {\n      // conversionTag 的计算和显示逻辑统一保持一致\n      formatter: function (datum) {\n        return i18n.get(['conversionTag', 'label']) + \": \" + conversionTagFormatter.apply(void 0, datum[FUNNEL_CONVERSATION]);\n      }\n    }\n  }; // 漏斗图样式\n\n  var style;\n\n  if (compareField || funnelStyle) {\n    style = function (datum) {\n      return deepAssign({}, // 对比漏斗图默认描边\n      compareField && {\n        lineWidth: 1,\n        stroke: '#fff'\n      }, isFunction(funnelStyle) ? funnelStyle(datum) : funnelStyle);\n    };\n  }\n\n  return deepAssign({\n    options: defaultOption\n  }, params, {\n    options: {\n      funnelStyle: style,\n      data: clone(data)\n    }\n  });\n}\n/**\n * geometry处理\n * @param params\n */\n\n\nfunction geometry(params) {\n  var options = params.options;\n  var compareField = options.compareField,\n      dynamicHeight = options.dynamicHeight,\n      seriesField = options.seriesField;\n\n  if (seriesField) {\n    return facetFunnel(params);\n  }\n\n  if (compareField) {\n    return compareFunnel(params);\n  }\n\n  if (dynamicHeight) {\n    return dynamicHeightFunnel(params);\n  }\n\n  return basicFunnel(params);\n}\n/**\n * meta 配置\n * @param params\n */\n\n\nexport function meta(params) {\n  var _a;\n\n  var options = params.options;\n  var xAxis = options.xAxis,\n      yAxis = options.yAxis,\n      xField = options.xField,\n      yField = options.yField;\n  return flow(scale((_a = {}, _a[xField] = xAxis, _a[yField] = yAxis, _a)))(params);\n}\n/**\n * 坐标轴\n * @param params\n */\n\nfunction axis(params) {\n  var chart = params.chart;\n  chart.axis(false);\n  return params;\n}\n/**\n * legend 配置\n * @param params\n */\n\n\nfunction legend(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend;\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    chart.legend(legend); // TODO FIX: legend-click 时间和转化率组件之间的关联\n  }\n\n  return params;\n}\n/**\n * 漏斗图适配器\n * @param chart\n * @param options\n */\n\n\nexport function adaptor(params) {\n  return flow(defaultOptions, geometry, meta, axis, tooltip, interaction, legend, animation, theme, annotation())(params);\n}","map":{"version":3,"mappings":"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","names":["isFunction","clone","interaction","animation","theme","scale","annotation","tooltip","getLocale","flow","deepAssign","conversionTagFormatter","basicFunnel","compareFunnel","facetFunnel","dynamicHeightFunnel","FUNNEL_CONVERSATION","FUNNEL_PERCENT","defaultOptions","params","options","xField","yField","locale","funnelStyle","data","i18n","defaultOption","label","compareField","fields","formatter","datum","offset","position","title","name","value","conversionTag","get","style","lineWidth","stroke","geometry","dynamicHeight","seriesField","meta","yAxis","_a","xAxis","axis","chart","legend","adaptor"],"sourceRoot":"","sources":["../../../src/plots/funnel/adaptor.ts"],"sourcesContent":["import { isFunction, clone } from '@antv/util';\nimport { Params } from '../../core/adaptor';\nimport { interaction, animation, theme, scale, annotation, tooltip } from '../../adaptor/common';\nimport { getLocale } from '../../core/locale';\nimport { Datum } from '../../types';\nimport { flow, deepAssign } from '../../utils';\nimport { conversionTagFormatter } from '../../utils/conversion';\nimport { FunnelOptions } from './types';\nimport { basicFunnel } from './geometries/basic';\nimport { compareFunnel } from './geometries/compare';\nimport { facetFunnel } from './geometries/facet';\nimport { dynamicHeightFunnel } from './geometries/dynamic-height';\nimport { FUNNEL_CONVERSATION, FUNNEL_PERCENT } from './constant';\n\n/**\n *\n * 各式漏斗图geometry实现细节有较大不同,\n * 1. 普通漏斗图：interval.shape('funnel')\n * 2. 对比漏斗图：分面\n * 3. 动态高度漏斗图：polypon\n * 4. 分面漏斗图：普通 + list 分面\n* /\n\n/**\n * options 处理\n * @param params\n */\nfunction defaultOptions(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { compareField, xField, yField, locale, funnelStyle, data } = options;\n  const i18n = getLocale(locale);\n\n  const defaultOption = {\n    label: compareField\n      ? {\n          fields: [xField, yField, compareField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n          formatter: (datum) => `${datum[yField]}`,\n        }\n      : {\n          fields: [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n          offset: 0,\n          position: 'middle',\n          formatter: (datum) => `${datum[xField]} ${datum[yField]}`,\n        },\n    tooltip: {\n      title: xField,\n      formatter: (datum) => {\n        return { name: datum[xField], value: datum[yField] };\n      },\n    },\n    conversionTag: {\n      // conversionTag 的计算和显示逻辑统一保持一致\n      formatter: (datum) =>\n        `${i18n.get(['conversionTag', 'label'])}: ${conversionTagFormatter(\n          ...(datum[FUNNEL_CONVERSATION] as [number, number])\n        )}`,\n    },\n  };\n\n  // 漏斗图样式\n  let style;\n  if (compareField || funnelStyle) {\n    style = (datum: Datum) => {\n      return deepAssign(\n        {},\n        // 对比漏斗图默认描边\n        compareField && { lineWidth: 1, stroke: '#fff' },\n        isFunction(funnelStyle) ? funnelStyle(datum) : funnelStyle\n      );\n    };\n  }\n\n  return deepAssign({ options: defaultOption }, params, { options: { funnelStyle: style, data: clone(data) } });\n}\n\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { compareField, dynamicHeight, seriesField } = options;\n  if (seriesField) {\n    return facetFunnel(params);\n  }\n  if (compareField) {\n    return compareFunnel(params);\n  }\n  if (dynamicHeight) {\n    return dynamicHeightFunnel(params);\n  }\n\n  return basicFunnel(params);\n}\n\n/**\n * meta 配置\n * @param params\n */\nexport function meta(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { xAxis, yAxis, xField, yField } = options;\n\n  return flow(\n    scale({\n      [xField]: xAxis,\n      [yField]: yAxis,\n    })\n  )(params);\n}\n\n/**\n * 坐标轴\n * @param params\n */\nfunction axis(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart } = params;\n  chart.axis(false);\n  return params;\n}\n\n/**\n * legend 配置\n * @param params\n */\nfunction legend(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { legend } = options;\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    chart.legend(legend);\n    // TODO FIX: legend-click 时间和转化率组件之间的关联\n  }\n\n  return params;\n}\n\n/**\n * 漏斗图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<FunnelOptions>) {\n  return flow(\n    defaultOptions,\n    geometry,\n    meta,\n    axis,\n    tooltip,\n    interaction,\n    legend,\n    animation,\n    theme,\n    annotation()\n  )(params);\n}\n"]},"metadata":{},"sourceType":"module"}