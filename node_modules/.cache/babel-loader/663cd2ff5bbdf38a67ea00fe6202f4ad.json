{"ast":null,"code":"import { __assign, __rest } from \"tslib\";\nimport { isArray, get, deepMix, isEqual } from '@antv/util';\nimport { interaction, animation, theme, tooltip, scale } from '../../adaptor/common';\nimport { schema as schemaGeometry } from '../../adaptor/geometries';\nimport { deepAssign, flow, findGeometry, transformLabel, getAdjustAppendPadding, normalPadding, resolveAllPadding } from '../../utils';\nimport { log, LEVEL } from '../../utils';\nimport { getColorMap, layoutVennData, islegalSets } from './utils';\nimport { ID_FIELD } from './constant';\nimport './shape';\nimport './label';\nimport './interactions';\n/** 图例默认预留空间 */\n\nexport var LEGEND_SPACE = 40;\n/**\n * 获取 color 映射\n */\n\nfunction colorMap(params, data, colorPalette) {\n  var chart = params.chart,\n      options = params.options;\n  var blendMode = options.blendMode,\n      setsField = options.setsField;\n\n  var _a = chart.getTheme(),\n      colors10 = _a.colors10,\n      colors20 = _a.colors20;\n\n  var palette = colorPalette;\n\n  if (!isArray(palette)) {\n    palette = data.filter(function (d) {\n      return d[setsField].length === 1;\n    }).length <= 10 ? colors10 : colors20;\n  }\n\n  var map = getColorMap(palette, data, blendMode, setsField);\n  return function (id) {\n    return map.get(id) || palette[0];\n  };\n}\n/**\n * color options 转换\n */\n\n\nfunction transformColor(params, data) {\n  var options = params.options;\n  var color = options.color;\n\n  if (typeof color !== 'function') {\n    var colorPalette = typeof color === 'string' ? [color] : color;\n    var map_1 = colorMap(params, data, colorPalette);\n    return function (datum) {\n      return map_1(datum[ID_FIELD]);\n    };\n  }\n\n  return color;\n}\n/**\n * 处理 padding\n */\n\n\nfunction padding(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend,\n      appendPadding = options.appendPadding,\n      padding = options.padding; // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n\n  var tempPadding = normalPadding(appendPadding);\n\n  if (legend !== false) {\n    tempPadding = getAdjustAppendPadding(appendPadding, get(legend, 'position'), LEGEND_SPACE);\n  }\n\n  chart.appendPadding = resolveAllPadding([tempPadding, padding]);\n  return params;\n}\n/**\n * 处理非法数据\n * @param params\n */\n\n\nfunction data(params) {\n  var options = params.options;\n  /* 如遇到 交集 中存在 非法元素 的情况，就过滤掉\n   * 如：\n   * data = [\n   *   { sets: ['A'], size: 3 }, // 集合\n   *   { sets: ['B'], size: 4 }, // 集合\n   *   { sets: ['A', 'B'], size: 2 }, // 交集\n   *   { sets: ['A', 'B', 'C'], size: 2 }, // 交集 (存在非法 C，过滤该条数据)\n   *   ...\n   * ]\n   */\n\n  var data = options['data'];\n\n  if (!data) {\n    log(LEVEL.WARN, false, 'warn: %s', '数据不能为空');\n    data = [];\n  } // 合法元素的集合：['A', 'B']\n\n\n  var currSets = data.filter(function (datum) {\n    return datum.sets.length === 1;\n  }).map(function (datum) {\n    return datum.sets[0];\n  }); // 过滤 data\n\n  var filterSets = data.filter(function (datum) {\n    var sets = datum.sets; // 存在非法元素，就过滤这条数据\n\n    return islegalSets(currSets, sets);\n  });\n  if (!isEqual(filterSets, data)) log(LEVEL.WARN, false, 'warn: %s', '交集中不能出现不存在的集合, 请输入合法数据');\n  return deepMix({}, params, {\n    options: {\n      data: filterSets\n    }\n  });\n}\n/**\n * geometry 处理\n * @param params\n */\n\n\nfunction geometry(params) {\n  var chart = params.chart,\n      options = params.options;\n  var pointStyle = options.pointStyle,\n      setsField = options.setsField,\n      sizeField = options.sizeField; // 获取容器大小\n\n  var _a = normalPadding(chart.appendPadding),\n      t = _a[0],\n      r = _a[1],\n      b = _a[2],\n      l = _a[3]; // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n\n\n  var customInfo = {\n    offsetX: l,\n    offsetY: t\n  }; // coordinateBBox + appendPadding = viewBBox, 不需要再计算 appendPadding 部分，因此直接使用 viewBBox\n\n  var _b = chart.viewBBox,\n      width = _b.width,\n      height = _b.height; // 处理padding输入不合理的情况， w 和 h 不能为负数\n\n  var vennData = layoutVennData(options, Math.max(width - (r + l), 0), Math.max(height - (t + b), 0), 0);\n  chart.data(vennData);\n  var ext = schemaGeometry(deepAssign({}, params, {\n    options: {\n      xField: 'x',\n      yField: 'y',\n      sizeField: sizeField,\n      seriesField: ID_FIELD,\n      rawFields: [setsField, sizeField],\n      schema: {\n        shape: 'venn',\n        style: pointStyle\n      }\n    }\n  })).ext;\n  var geometry = ext.geometry;\n  geometry.customInfo(customInfo);\n  var colorOptions = transformColor(params, vennData); // 韦恩图试点, color 通道只能映射一个字段. 通过外部查找获取 datum\n\n  if (typeof colorOptions === 'function') {\n    geometry.color(ID_FIELD, function (id) {\n      var datum = vennData.find(function (d) {\n        return d[ID_FIELD] === id;\n      });\n      var defaultColor = colorMap(params, vennData)(id);\n      return colorOptions(datum, defaultColor);\n    });\n  }\n\n  return params;\n}\n/**\n * 处理 label\n * @param params\n */\n\n\nfunction label(params) {\n  var chart = params.chart,\n      options = params.options;\n  var label = options.label; // 获取容器大小\n\n  var _a = normalPadding(chart.appendPadding),\n      t = _a[0],\n      l = _a[3]; // 传入 label 布局函数所需的 自定义参数\n\n\n  var customLabelInfo = {\n    offsetX: l,\n    offsetY: t\n  };\n  var geometry = findGeometry(chart, 'schema');\n\n  if (!label) {\n    geometry.label(false);\n  } else {\n    var callback = label.callback,\n        cfg = __rest(label, [\"callback\"]);\n\n    geometry.label({\n      fields: ['id'],\n      callback: callback,\n      cfg: deepMix({}, transformLabel(cfg), {\n        // 使用 G2 的 自定义label 修改位置\n        type: 'venn',\n        customLabelInfo: customLabelInfo\n      })\n    });\n  }\n\n  return params;\n}\n/**\n * legend 配置\n * @param params\n */\n\n\nexport function legend(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend,\n      sizeField = options.sizeField;\n  chart.legend(ID_FIELD, legend); // 强制不开启 连续图例\n\n  chart.legend(sizeField, false);\n  return params;\n}\n/**\n * 默认关闭坐标轴\n * @param params\n */\n\nexport function axis(params) {\n  var chart = params.chart;\n  chart.axis(false);\n  return params;\n}\n/**\n * 韦恩图 interaction 交互适配器\n */\n\nfunction vennInteraction(params) {\n  var options = params.options,\n      chart = params.chart;\n  var interactions = options.interactions;\n\n  if (interactions) {\n    var MAP_1 = {\n      'legend-active': 'venn-legend-active',\n      'legend-highlight': 'venn-legend-highlight'\n    };\n    interaction(deepAssign({}, params, {\n      options: {\n        interactions: interactions.map(function (i) {\n          return __assign(__assign({}, i), {\n            type: MAP_1[i.type] || i.type\n          });\n        })\n      }\n    }));\n  }\n\n  chart.removeInteraction('legend-active');\n  chart.removeInteraction('legend-highlight');\n  return params;\n}\n/**\n * 图适配器\n * @param chart\n * @param options\n */\n\n\nexport function adaptor(params) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(padding, theme, data, geometry, label, scale({}), legend, axis, tooltip, vennInteraction, animation // ... 其他的 adaptor flow\n  )(params);\n}","map":{"version":3,"mappings":";AACA,SAASA,OAAT,EAAkBC,GAAlB,EAAuBC,OAAvB,EAAgCC,OAAhC,QAA+C,YAA/C;AACA,SAASC,WAAT,EAAsBC,SAAtB,EAAiCC,KAAjC,EAAwCC,OAAxC,EAAiDC,KAAjD,QAA8D,sBAA9D;AAEA,SAASC,MAAM,IAAIC,cAAnB,QAAyC,0BAAzC;AACA,SACEC,UADF,EAEEC,IAFF,EAGEC,YAHF,EAIEC,cAJF,EAKEC,sBALF,EAMEC,aANF,EAOEC,iBAPF,QAQO,aARP;AAUA,SAASC,GAAT,EAAcC,KAAd,QAA2B,aAA3B;AACA,SAASC,WAAT,EAAsBC,cAAtB,EAAsCC,WAAtC,QAAyD,SAAzD;AAEA,SAASC,QAAT,QAAyB,YAAzB;AACA,OAAO,SAAP;AACA,OAAO,SAAP;AACA,OAAO,gBAAP;AAEA;;AACA,OAAO,IAAMC,YAAY,GAAG,EAArB;AAEP;;;;AAGA,SAASC,QAAT,CAAkBC,MAAlB,EAA+CC,IAA/C,EAA+DC,YAA/D,EAAsF;EAC5E,SAAK,GAAcF,MAAM,MAAzB;EAAA,IAAOG,OAAO,GAAKH,MAAM,QAAzB;EACA,aAAS,GAAgBG,OAAO,UAAhC;EAAA,IAAWC,SAAS,GAAKD,OAAO,UAAhC;;EACF,SAAyBE,KAAK,CAACC,QAAN,EAAzB;EAAA,IAAEC,QAAQ,cAAV;EAAA,IAAYC,QAAQ,cAApB;;EACN,IAAIC,OAAO,GAAGP,YAAd;;EACA,IAAI,CAAC5B,OAAO,CAACmC,OAAD,CAAZ,EAAuB;IACrBA,OAAO,GAAGR,IAAI,CAACS,MAAL,CAAY,UAACC,CAAD,EAAE;MAAK,QAAC,CAACP,SAAD,CAAD,CAAaQ,MAAb,KAAwB,CAAxB;IAAyB,CAA5C,EAA8CA,MAA9C,IAAwD,EAAxD,GAA6DL,QAA7D,GAAwEC,QAAlF;EACD;;EACD,IAAMK,GAAG,GAAGnB,WAAW,CAACe,OAAD,EAAUR,IAAV,EAAgBa,SAAhB,EAA2BV,SAA3B,CAAvB;EAEA,OAAO,UAACW,EAAD,EAAW;IAAK,UAAG,CAACxC,GAAJ,CAAQwC,EAAR,KAAeN,OAAO,CAAC,CAAD,CAAtB;EAAyB,CAAhD;AACD;AAED;;;;;AAGA,SAASO,cAAT,CAAwBhB,MAAxB,EAAqDC,IAArD,EAAmE;EACzD,WAAO,GAAKD,MAAM,QAAlB;EACA,SAAK,GAAKG,OAAO,MAAjB;;EAER,IAAI,OAAOc,KAAP,KAAiB,UAArB,EAAiC;IAC/B,IAAMf,YAAY,GAAG,OAAOe,KAAP,KAAiB,QAAjB,GAA4B,CAACA,KAAD,CAA5B,GAAsCA,KAA3D;IACA,IAAMC,KAAG,GAAGnB,QAAQ,CAACC,MAAD,EAASC,IAAT,EAAeC,YAAf,CAApB;IACA,OAAO,UAACiB,KAAD,EAAa;MAAK,YAAG,CAACA,KAAK,CAACtB,QAAD,CAAN,CAAH;IAAoB,CAA7C;EACD;;EACD,OAAOoB,KAAP;AACD;AAED;;;;;AAGA,SAASG,OAAT,CAAiBpB,MAAjB,EAA4C;EAClC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOG,OAAO,GAAKH,MAAM,QAAzB;EACA,UAAM,GAA6BG,OAAO,OAA1C;EAAA,IAAQkB,aAAa,GAAclB,OAAO,cAA1C;EAAA,IAAuBiB,OAAO,GAAKjB,OAAO,QAA1C,CAFkC,CAI1C;;EACA,IAAImB,WAAW,GAAahC,aAAa,CAAC+B,aAAD,CAAzC;;EACA,IAAIE,MAAM,KAAK,KAAf,EAAsB;IACpBD,WAAW,GAAGjC,sBAAsB,CAACgC,aAAD,EAAgB9C,GAAG,CAACgD,MAAD,EAAS,UAAT,CAAnB,EAAyCzB,YAAzC,CAApC;EACD;;EAEDO,KAAK,CAACgB,aAAN,GAAsB9B,iBAAiB,CAAC,CAAC+B,WAAD,EAAcF,OAAd,CAAD,CAAvC;EAEA,OAAOpB,MAAP;AACD;AAED;;;;;;AAIA,SAASC,IAAT,CAAcD,MAAd,EAAyC;EAC/B,WAAO,GAAKA,MAAM,QAAlB;EAER;;;;;;;;;;;EAWA,IAAIC,IAAI,GAAGE,OAAO,CAAC,MAAD,CAAlB;;EACA,IAAI,CAACF,IAAL,EAAW;IACTT,GAAG,CAACC,KAAK,CAAC+B,IAAP,EAAa,KAAb,EAAoB,UAApB,EAAgC,QAAhC,CAAH;IACAvB,IAAI,GAAG,EAAP;EACD,CAlBsC,CAoBvC;;;EACA,IAAMwB,QAAQ,GAAGxB,IAAI,CAACS,MAAL,CAAY,UAACS,KAAD,EAAM;IAAK,YAAK,CAACO,IAAN,CAAWd,MAAX,KAAsB,CAAtB;EAAuB,CAA9C,EAAgDC,GAAhD,CAAoD,UAACM,KAAD,EAAM;IAAK,YAAK,CAACO,IAAN,CAAW,CAAX;EAAa,CAA5E,CAAjB,CArBuC,CAsBvC;;EACA,IAAMC,UAAU,GAAG1B,IAAI,CAACS,MAAL,CAAY,UAACS,KAAD,EAAM;IACnC,IAAMO,IAAI,GAAGP,KAAK,CAACO,IAAnB,CADmC,CAEnC;;IACA,OAAO9B,WAAW,CAAC6B,QAAD,EAAWC,IAAX,CAAlB;EACD,CAJkB,CAAnB;EAMA,IAAI,CAACjD,OAAO,CAACkD,UAAD,EAAa1B,IAAb,CAAZ,EAAgCT,GAAG,CAACC,KAAK,CAAC+B,IAAP,EAAa,KAAb,EAAoB,UAApB,EAAgC,wBAAhC,CAAH;EAEhC,OAAOhD,OAAO,CAAC,EAAD,EAAKwB,MAAL,EAAa;IACzBG,OAAO,EAAE;MACPF,IAAI,EAAE0B;IADC;EADgB,CAAb,CAAd;AAKD;AAED;;;;;;AAIA,SAASC,QAAT,CAAkB5B,MAAlB,EAA6C;EACnC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOG,OAAO,GAAKH,MAAM,QAAzB;EACA,cAAU,GAA2BG,OAAO,WAA5C;EAAA,IAAYC,SAAS,GAAgBD,OAAO,UAA5C;EAAA,IAAuB0B,SAAS,GAAK1B,OAAO,UAA5C,CAFmC,CAI3C;;EACM,SAAeb,aAAa,CAACe,KAAK,CAACgB,aAAP,CAA5B;EAAA,IAACS,CAAC,QAAF;EAAA,IAAIC,CAAC,QAAL;EAAA,IAAOC,CAAC,QAAR;EAAA,IAAUC,CAAC,QAAX,CALqC,CAM3C;;;EACA,IAAMC,UAAU,GAAe;IAAEC,OAAO,EAAEF,CAAX;IAAcG,OAAO,EAAEN;EAAvB,CAA/B,CAP2C,CAQ3C;;EACM,SAAoBzB,KAAK,CAACgC,QAA1B;EAAA,IAAEC,KAAK,WAAP;EAAA,IAASC,MAAM,YAAf,CATqC,CAU3C;;EACA,IAAMC,QAAQ,GAAa7C,cAAc,CAACQ,OAAD,EAAUsC,IAAI,CAACC,GAAL,CAASJ,KAAK,IAAIP,CAAC,GAAGE,CAAR,CAAd,EAA0B,CAA1B,CAAV,EAAwCQ,IAAI,CAACC,GAAL,CAASH,MAAM,IAAIT,CAAC,GAAGE,CAAR,CAAf,EAA2B,CAA3B,CAAxC,EAAuE,CAAvE,CAAzC;EACA3B,KAAK,CAACJ,IAAN,CAAWuC,QAAX;EAEQ,OAAG,GAAKxD,cAAc,CAC5BC,UAAU,CAAC,EAAD,EAAKe,MAAL,EAAa;IACrBG,OAAO,EAAE;MACPwC,MAAM,EAAE,GADD;MAEPC,MAAM,EAAE,GAFD;MAGPf,SAAS,EAAEA,SAHJ;MAIPgB,WAAW,EAAEhD,QAJN;MAKPiD,SAAS,EAAE,CAAC1C,SAAD,EAAYyB,SAAZ,CALJ;MAMP9C,MAAM,EAAE;QACNgE,KAAK,EAAE,MADD;QAENC,KAAK,EAAEC;MAFD;IAND;EADY,CAAb,CADkB,CAAd,CAcfC,GAdO;EAgBR,IAAMtB,QAAQ,GAAGsB,GAAG,CAACtB,QAArB;EACAA,QAAQ,CAACM,UAAT,CAAoBA,UAApB;EAEA,IAAMiB,YAAY,GAAGnC,cAAc,CAAChB,MAAD,EAASwC,QAAT,CAAnC,CAjC2C,CAkC3C;;EACA,IAAI,OAAOW,YAAP,KAAwB,UAA5B,EAAwC;IACtCvB,QAAQ,CAACX,KAAT,CAAepB,QAAf,EAAyB,UAACkB,EAAD,EAAG;MAC1B,IAAMI,KAAK,GAAGqB,QAAQ,CAACY,IAAT,CAAc,UAACzC,CAAD,EAAE;QAAK,QAAC,CAACd,QAAD,CAAD,KAAgBkB,EAAhB;MAAkB,CAAvC,CAAd;MACA,IAAMsC,YAAY,GAAGtD,QAAQ,CAACC,MAAD,EAASwC,QAAT,CAAR,CAA2BzB,EAA3B,CAArB;MACA,OAAOoC,YAAY,CAAChC,KAAD,EAAQkC,YAAR,CAAnB;IACD,CAJD;EAKD;;EAED,OAAOrD,MAAP;AACD;AAED;;;;;;AAIA,SAASsD,KAAT,CAAetD,MAAf,EAA0C;EAChC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOG,OAAO,GAAKH,MAAM,QAAzB;EACA,SAAK,GAAKG,OAAO,MAAjB,CAFgC,CAIxC;;EACM,SAAab,aAAa,CAACe,KAAK,CAACgB,aAAP,CAA1B;EAAA,IAACS,CAAC,QAAF;EAAA,IAAQG,CAAC,QAAT,CALkC,CAMxC;;;EACA,IAAMsB,eAAe,GAAG;IAAEpB,OAAO,EAAEF,CAAX;IAAcG,OAAO,EAAEN;EAAvB,CAAxB;EAEA,IAAMF,QAAQ,GAAGzC,YAAY,CAACkB,KAAD,EAAQ,QAAR,CAA7B;;EAEA,IAAI,CAACiD,KAAL,EAAY;IACV1B,QAAQ,CAAC0B,KAAT,CAAe,KAAf;EACD,CAFD,MAEO;IACG,YAAQ,GAAaA,KAAK,SAA1B;IAAA,IAAaE,GAAG,UAAKF,KAAL,EAAlB,YAAkB,CAAhB;;IACR1B,QAAQ,CAAC0B,KAAT,CAAe;MACbG,MAAM,EAAE,CAAC,IAAD,CADK;MAEbC,QAAQ,UAFK;MAGbF,GAAG,EAAEhF,OAAO,CAAC,EAAD,EAAKY,cAAc,CAACoE,GAAD,CAAnB,EAA0B;QACpC;QACAG,IAAI,EAAE,MAF8B;QAGpCJ,eAAe;MAHqB,CAA1B;IAHC,CAAf;EASD;;EAED,OAAOvD,MAAP;AACD;AAED;;;;;;AAIA,OAAM,SAAUuB,MAAV,CAAiBvB,MAAjB,EAA4C;EACxC,SAAK,GAAcA,MAAM,MAAzB;EAAA,IAAOG,OAAO,GAAKH,MAAM,QAAzB;EACA,UAAM,GAAgBG,OAAO,OAA7B;EAAA,IAAQ0B,SAAS,GAAK1B,OAAO,UAA7B;EAERE,KAAK,CAACkB,MAAN,CAAa1B,QAAb,EAAuB0B,MAAvB,EAJgD,CAKhD;;EACAlB,KAAK,CAACkB,MAAN,CAAaM,SAAb,EAAwB,KAAxB;EAEA,OAAO7B,MAAP;AACD;AAED;;;;;AAIA,OAAM,SAAU4D,IAAV,CAAe5D,MAAf,EAA0C;EACtC,SAAK,GAAKA,MAAM,MAAhB;EACRK,KAAK,CAACuD,IAAN,CAAW,KAAX;EAEA,OAAO5D,MAAP;AACD;AAED;;;;AAGA,SAAS6D,eAAT,CAAyB7D,MAAzB,EAAoD;EAC1C,WAAO,GAAYA,MAAM,QAAzB;EAAA,IAASK,KAAK,GAAKL,MAAM,MAAzB;EACA,gBAAY,GAAKG,OAAO,aAAxB;;EAER,IAAI2D,YAAJ,EAAkB;IAChB,IAAMC,KAAG,GAAG;MACV,iBAAiB,oBADP;MAEV,oBAAoB;IAFV,CAAZ;IAIArF,WAAW,CACTO,UAAU,CAAC,EAAD,EAAKe,MAAL,EAAa;MACrBG,OAAO,EAAE;QACP2D,YAAY,EAAEA,YAAY,CAACjD,GAAb,CAAiB,UAACmD,CAAD,EAAE;UAAK,6BACjCA,CADiC,GAChC;YACJL,IAAI,EAAEI,KAAG,CAACC,CAAC,CAACL,IAAH,CAAH,IAAeK,CAAC,CAACL;UADnB,CADgC;QAGpC,CAHY;MADP;IADY,CAAb,CADD,CAAX;EAUD;;EAEDtD,KAAK,CAAC4D,iBAAN,CAAwB,eAAxB;EACA5D,KAAK,CAAC4D,iBAAN,CAAwB,kBAAxB;EACA,OAAOjE,MAAP;AACD;AAED;;;;;;;AAKA,OAAM,SAAUkE,OAAV,CAAkBlE,MAAlB,EAA6C;EACjD;EACA,OAAOd,IAAI,CACTkC,OADS,EAETxC,KAFS,EAGTqB,IAHS,EAIT2B,QAJS,EAKT0B,KALS,EAMTxE,KAAK,CAAC,EAAD,CANI,EAOTyC,MAPS,EAQTqC,IARS,EAST/E,OATS,EAUTgF,eAVS,EAWTlF,SAXS,CAYT;EAZS,CAAJ,CAaLqB,MAbK,CAAP;AAcD","names":["isArray","get","deepMix","isEqual","interaction","animation","theme","tooltip","scale","schema","schemaGeometry","deepAssign","flow","findGeometry","transformLabel","getAdjustAppendPadding","normalPadding","resolveAllPadding","log","LEVEL","getColorMap","layoutVennData","islegalSets","ID_FIELD","LEGEND_SPACE","colorMap","params","data","colorPalette","options","setsField","chart","getTheme","colors10","colors20","palette","filter","d","length","map","blendMode","id","transformColor","color","map_1","datum","padding","appendPadding","tempPadding","legend","WARN","currSets","sets","filterSets","geometry","sizeField","t","r","b","l","customInfo","offsetX","offsetY","viewBBox","width","height","vennData","Math","max","xField","yField","seriesField","rawFields","shape","style","pointStyle","ext","colorOptions","find","defaultColor","label","customLabelInfo","cfg","fields","callback","type","axis","vennInteraction","interactions","MAP_1","i","removeInteraction","adaptor"],"sourceRoot":"","sources":["../../../src/plots/venn/adaptor.ts"],"sourcesContent":["import { Geometry } from '@antv/g2';\nimport { isArray, get, deepMix, isEqual } from '@antv/util';\nimport { interaction, animation, theme, tooltip, scale } from '../../adaptor/common';\nimport { Params } from '../../core/adaptor';\nimport { schema as schemaGeometry } from '../../adaptor/geometries';\nimport {\n  deepAssign,\n  flow,\n  findGeometry,\n  transformLabel,\n  getAdjustAppendPadding,\n  normalPadding,\n  resolveAllPadding,\n} from '../../utils';\nimport { Datum } from '../../types';\nimport { log, LEVEL } from '../../utils';\nimport { getColorMap, layoutVennData, islegalSets } from './utils';\nimport { CustomInfo, VennData, VennOptions } from './types';\nimport { ID_FIELD } from './constant';\nimport './shape';\nimport './label';\nimport './interactions';\n\n/** 图例默认预留空间 */\nexport const LEGEND_SPACE = 40;\n\n/**\n * 获取 color 映射\n */\nfunction colorMap(params: Params<VennOptions>, data: VennData, colorPalette?: string[]) {\n  const { chart, options } = params;\n  const { blendMode, setsField } = options;\n  const { colors10, colors20 } = chart.getTheme();\n  let palette = colorPalette;\n  if (!isArray(palette)) {\n    palette = data.filter((d) => d[setsField].length === 1).length <= 10 ? colors10 : colors20;\n  }\n  const map = getColorMap(palette, data, blendMode, setsField);\n\n  return (id: string) => map.get(id) || palette[0];\n}\n\n/**\n * color options 转换\n */\nfunction transformColor(params: Params<VennOptions>, data: VennData): VennOptions['color'] {\n  const { options } = params;\n  const { color } = options;\n\n  if (typeof color !== 'function') {\n    const colorPalette = typeof color === 'string' ? [color] : color;\n    const map = colorMap(params, data, colorPalette);\n    return (datum: Datum) => map(datum[ID_FIELD]);\n  }\n  return color;\n}\n\n/**\n * 处理 padding\n */\nfunction padding(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { legend, appendPadding, padding } = options;\n\n  // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n  let tempPadding: number[] = normalPadding(appendPadding);\n  if (legend !== false) {\n    tempPadding = getAdjustAppendPadding(appendPadding, get(legend, 'position'), LEGEND_SPACE);\n  }\n\n  chart.appendPadding = resolveAllPadding([tempPadding, padding]);\n\n  return params;\n}\n\n/**\n * 处理非法数据\n * @param params\n */\nfunction data(params: Params<VennOptions>): Params<VennOptions> {\n  const { options } = params;\n\n  /* 如遇到 交集 中存在 非法元素 的情况，就过滤掉\n   * 如：\n   * data = [\n   *   { sets: ['A'], size: 3 }, // 集合\n   *   { sets: ['B'], size: 4 }, // 集合\n   *   { sets: ['A', 'B'], size: 2 }, // 交集\n   *   { sets: ['A', 'B', 'C'], size: 2 }, // 交集 (存在非法 C，过滤该条数据)\n   *   ...\n   * ]\n   */\n\n  let data = options['data'];\n  if (!data) {\n    log(LEVEL.WARN, false, 'warn: %s', '数据不能为空');\n    data = [];\n  }\n\n  // 合法元素的集合：['A', 'B']\n  const currSets = data.filter((datum) => datum.sets.length === 1).map((datum) => datum.sets[0]);\n  // 过滤 data\n  const filterSets = data.filter((datum) => {\n    const sets = datum.sets;\n    // 存在非法元素，就过滤这条数据\n    return islegalSets(currSets, sets);\n  });\n\n  if (!isEqual(filterSets, data)) log(LEVEL.WARN, false, 'warn: %s', '交集中不能出现不存在的集合, 请输入合法数据');\n\n  return deepMix({}, params, {\n    options: {\n      data: filterSets,\n    },\n  });\n}\n\n/**\n * geometry 处理\n * @param params\n */\nfunction geometry(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { pointStyle, setsField, sizeField } = options;\n\n  // 获取容器大小\n  const [t, r, b, l] = normalPadding(chart.appendPadding);\n  // 处理 legend 的位置. 默认预留 40px, 业务上可以通过 appendPadding 增加\n  const customInfo: CustomInfo = { offsetX: l, offsetY: t };\n  // coordinateBBox + appendPadding = viewBBox, 不需要再计算 appendPadding 部分，因此直接使用 viewBBox\n  const { width, height } = chart.viewBBox;\n  // 处理padding输入不合理的情况， w 和 h 不能为负数\n  const vennData: VennData = layoutVennData(options, Math.max(width - (r + l), 0), Math.max(height - (t + b), 0), 0);\n  chart.data(vennData);\n\n  const { ext } = schemaGeometry(\n    deepAssign({}, params, {\n      options: {\n        xField: 'x',\n        yField: 'y',\n        sizeField: sizeField,\n        seriesField: ID_FIELD,\n        rawFields: [setsField, sizeField],\n        schema: {\n          shape: 'venn',\n          style: pointStyle,\n        },\n      },\n    })\n  );\n\n  const geometry = ext.geometry as Geometry;\n  geometry.customInfo(customInfo);\n\n  const colorOptions = transformColor(params, vennData);\n  // 韦恩图试点, color 通道只能映射一个字段. 通过外部查找获取 datum\n  if (typeof colorOptions === 'function') {\n    geometry.color(ID_FIELD, (id) => {\n      const datum = vennData.find((d) => d[ID_FIELD] === id);\n      const defaultColor = colorMap(params, vennData)(id);\n      return colorOptions(datum, defaultColor);\n    });\n  }\n\n  return params;\n}\n\n/**\n * 处理 label\n * @param params\n */\nfunction label(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { label } = options;\n\n  // 获取容器大小\n  const [t, , , l] = normalPadding(chart.appendPadding);\n  // 传入 label 布局函数所需的 自定义参数\n  const customLabelInfo = { offsetX: l, offsetY: t };\n\n  const geometry = findGeometry(chart, 'schema');\n\n  if (!label) {\n    geometry.label(false);\n  } else {\n    const { callback, ...cfg } = label;\n    geometry.label({\n      fields: ['id'],\n      callback,\n      cfg: deepMix({}, transformLabel(cfg), {\n        // 使用 G2 的 自定义label 修改位置\n        type: 'venn',\n        customLabelInfo,\n      }),\n    });\n  }\n\n  return params;\n}\n\n/**\n * legend 配置\n * @param params\n */\nexport function legend(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart, options } = params;\n  const { legend, sizeField } = options;\n\n  chart.legend(ID_FIELD, legend);\n  // 强制不开启 连续图例\n  chart.legend(sizeField, false);\n\n  return params;\n}\n\n/**\n * 默认关闭坐标轴\n * @param params\n */\nexport function axis(params: Params<VennOptions>): Params<VennOptions> {\n  const { chart } = params;\n  chart.axis(false);\n\n  return params;\n}\n\n/**\n * 韦恩图 interaction 交互适配器\n */\nfunction vennInteraction(params: Params<VennOptions>): Params<VennOptions> {\n  const { options, chart } = params;\n  const { interactions } = options;\n\n  if (interactions) {\n    const MAP = {\n      'legend-active': 'venn-legend-active',\n      'legend-highlight': 'venn-legend-highlight',\n    };\n    interaction(\n      deepAssign({}, params, {\n        options: {\n          interactions: interactions.map((i) => ({\n            ...i,\n            type: MAP[i.type] || i.type,\n          })),\n        },\n      })\n    );\n  }\n\n  chart.removeInteraction('legend-active');\n  chart.removeInteraction('legend-highlight');\n  return params;\n}\n\n/**\n * 图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<VennOptions>) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(\n    padding,\n    theme,\n    data,\n    geometry,\n    label,\n    scale({}),\n    legend,\n    axis,\n    tooltip,\n    vennInteraction,\n    animation\n    // ... 其他的 adaptor flow\n  )(params);\n}\n"]},"metadata":{},"sourceType":"module"}